
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>C Error Handling - kennary island</title>
  <meta name="author" content="Kenny Yu">

  
  <meta name="description" content="After taking an operating systems class last year and taking a data systems
class this semester, I&#8217;ve picked up a few C patterns
to make it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kennyyu.me/blog/2014/03/19/c-error-handling">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="kennary island" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25289622-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kennary island</a></h1>
  
    <h2>eat, enjoy, explore</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kennyyu.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">C Error Handling</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-19T19:42:00-04:00" pubdate data-updated="true">Mar 19<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>After taking an operating systems class last year and taking a data systems
class this semester, I&#8217;ve picked up a few C patterns
to make it easier to handle error conditions in C.</p>

<p>Consider the following example from my data systems class, where I initialize
a directory to act as persistent storage for my database.</p>

<figure class='code'><figcaption><span>storage struct</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">storage</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">st_dbdir</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>   <span class="c1">// name of the db directory</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">st_file</span><span class="p">;</span> <span class="c1">// pointer to metadata file</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">lock</span> <span class="o">*</span><span class="n">st_lock</span><span class="p">;</span> <span class="c1">// protect addition of columns</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">columnarray</span> <span class="o">*</span><span class="n">st_open_cols</span><span class="p">;</span> <span class="c1">// array of open columns</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>Here&#8217;s a first pass at initializing a storage struct. In this example,
I ignore all errors and will throw an assertion error if an error
occurs.</p>

<figure class='code'><figcaption><span>storage: naive initialization</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span>
</span><span class='line'><span class="nf">storage_init</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dbdir</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span><span class="n">storage</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">storage</span><span class="p">));</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">storage</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">=</span> <span class="n">lock_create</span><span class="p">();</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">=</span> <span class="n">columnarray_create</span><span class="p">();</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_dbdir</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">METADATA_FILENAME</span><span class="p">);</span>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="n">file_open</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Obviously, this is not robust. If any of the operations return
an error, we would get an assertion failure and our server
process would exit unexpectedly. Thus, we need to check for errors
and cleanup all the calls that occurred before the error.</p>

<figure class='code'><figcaption><span>storage: quadratic error handling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span>
</span><span class='line'><span class="nf">storage_init</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dbdir</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span><span class="n">storage</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">storage</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">=</span> <span class="n">lock_create</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">=</span> <span class="n">columnarray_create</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">lock_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">columnarray_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span><span class="p">);</span>
</span><span class='line'>        <span class="n">lock_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_dbdir</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">METADATA_FILENAME</span><span class="p">);</span>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="n">file_open</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">assert</span><span class="p">(</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">columnarray_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span><span class="p">);</span>
</span><span class='line'>        <span class="n">lock_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, performing error handling naively like this
results in quadratic growth in cleanup operations: each
error checking needs to cleanup every operation before it,
and as a result, the <code>free(storage)</code> line gets repeated
multiple times. Can we do better?</p>

<p>Yes! The key to this is use <code>goto</code> statements. Many
introductory computer science courses discourage use
of goto statements, and rightfully so: goto statements,
if used inappropriately, can lead to spaghetti code
and can make code very difficult to reason about. However,
error handling is a perfect use for goto statements
to avoid quadratic code growth.</p>

<figure class='code'><figcaption><span>storage: goto error handling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span>
</span><span class='line'><span class="nf">storage_init</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dbdir</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span><span class="n">storage</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">storage</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">=</span> <span class="n">lock_create</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">cleanup_malloc</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">=</span> <span class="n">columnarray_create</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">cleanup_lock</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">cleanup_colarray</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_dbdir</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">METADATA_FILENAME</span><span class="p">);</span>
</span><span class='line'>    <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">=</span> <span class="n">file_open</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">cleanup_mkdir</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// success</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nl">cleanup_mkdir:</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_colarray:</span>
</span><span class='line'>    <span class="n">columnarray_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_lock:</span>
</span><span class='line'>    <span class="n">lock_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_malloc:</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>    <span class="n">storage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">done:</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>By laying out
the error handling code labels in reverse order in which
the operations were invoked, we can quickly jump
to the appropriate position to start cleaning up
all the operations that occurred before it. This eliminates
the quadratic code growth in error handling! Furthermore,
there is only one exit point of this function (at the very
bottom), and reasoning about exit points for this version
is much easier than the previous version, especially
when we throw in concurrencry primitivies and needing to remember
to release locks.</p>

<p>To eliminate the boiler plate of checking the return value
and then jumping to the appropriate label on error, I wrote
a couple of useful macros. It relies on design decision
to make all functions that may have an error:</p>

<ol>
<li>Return <code>NULL</code> (e.g., if the function allocates a data structure)</li>
<li>Return <code>int</code>, where the int is an error code specific to your application, and 0 is success.</li>
</ol>


<figure class='code'><figcaption><span>dberror.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef _DBERROR_H_</span>
</span><span class='line'><span class="cp">#define _DBERROR_H_</span>
</span><span class='line'>
</span><span class='line'><span class="k">enum</span> <span class="n">dberror</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DBSUCCESS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="n">DBENOMEM</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span> <span class="c1">// other errors</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dberror_string</span><span class="p">(</span><span class="k">enum</span> <span class="n">dberror</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">dberror_log</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
</span><span class='line'>                 <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define DBLOG(result) \</span>
</span><span class='line'><span class="cp">        dberror_log((char *) dberror_string((result)), \</span>
</span><span class='line'><span class="cp">                     __FILE__, __LINE__, __func__);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this code, I define an enumeration <code>enum dberror</code> to represent
the different kinds of error codes for my database application.
I also provide a <code>DBLOG(result)</code> macro which, when given an error
code, prints out the human readable string for that code, as well
as the file, line number, and function where <code>DBLOG</code> was invoked.
By designing your internal API using the two points above and invoking
<code>DBLOG</code> every time an error occurs, we effectively get a stack
trace for every error!</p>

<p>Now let&#8217;s combine this error logging facility to reduce the
boiler plate for the error handling code above.</p>

<figure class='code'><figcaption><span>try.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef _TRY_H_</span>
</span><span class='line'><span class="cp">#define _TRY_H_</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;stddef.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;dberror.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define TRY(result, expr, cleanup) \</span>
</span><span class='line'><span class="cp">    (result) = (expr); \</span>
</span><span class='line'><span class="cp">    if ((result)) { \</span>
</span><span class='line'><span class="cp">        DBLOG((result)); \</span>
</span><span class='line'><span class="cp">        goto cleanup; \</span>
</span><span class='line'><span class="cp">    }</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define TRYNULL(result, err, var, expr, cleanup) \</span>
</span><span class='line'><span class="cp">    (var) = (expr); \</span>
</span><span class='line'><span class="cp">    if ((var) == NULL) { \</span>
</span><span class='line'><span class="cp">        (result) = (err); \</span>
</span><span class='line'><span class="cp">        DBLOG((result)); \</span>
</span><span class='line'><span class="cp">        goto cleanup; \</span>
</span><span class='line'><span class="cp">    }</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>TRY</code> macro allows us to execute <code>expr</code>, and if
that returns a nonzero error code, we jump to the provided
cleanup label.</p>

<p>The <code>TRYNULL</code> macro is similar&#8211;it assigns <code>var</code> to be the
result of <code>expr</code>, checks if <code>var</code> is <code>NULL</code>, and if it is,
assigns the appropriate error code to result and jumps to
the cleanup label.</p>

<p>Using this, let&#8217;s write our final version of storage:</p>

<figure class='code'><figcaption><span>storage: try pattern</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span>
</span><span class='line'><span class="nf">storage_init</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dbdir</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">storage</span> <span class="o">*</span><span class="n">storage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">TRYNULL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DBENOMEM</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">storage</span><span class="p">)),</span> <span class="n">done</span><span class="p">);</span>
</span><span class='line'>    <span class="n">TRYNULL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DBENOMEM</span><span class="p">,</span> <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">,</span> <span class="n">lock_create</span><span class="p">(),</span> <span class="n">cleanup_malloc</span><span class="p">);</span>
</span><span class='line'>    <span class="n">TRYNULL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DBENOMEM</span><span class="p">,</span> <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span><span class="p">,</span> <span class="n">columnarray_create</span><span class="p">(),</span> <span class="n">cleanup_lock</span><span class="p">);</span>
</span><span class='line'>    <span class="n">TRY</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">),</span> <span class="n">cleanup_colarray</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_dbdir</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">METADATA_FILENAME</span><span class="p">);</span>
</span><span class='line'>    <span class="n">TRYNULL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">DBEIONOFILE</span><span class="p">,</span> <span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_file</span><span class="p">,</span> <span class="n">file_open</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">cleanup_mkdir</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// success</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nl">cleanup_mkdir:</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_colarray:</span>
</span><span class='line'>    <span class="n">columnarray_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_open_cols</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_lock:</span>
</span><span class='line'>    <span class="n">lock_destroy</span><span class="p">(</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">st_lock</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">cleanup_malloc:</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">storage</span><span class="p">);</span>
</span><span class='line'>    <span class="n">storage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">done:</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nice and simple! Here&#8217;s all the things that this pattern addressed:</p>

<ul>
<li>Allow error handling using only linear, and not quadratic, code growth.</li>
<li>Our <code>TRY</code> and <code>TRYNULL</code> macros eliminate the boiler plate, and automatically performs logging to give us a stack trace of errors.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kenny Yu</span></span>

      








  


<time datetime="2014-03-19T19:42:00-04:00" pubdate data-updated="true">Mar 19<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/c/'>c</a>, <a class='category' href='/blog/categories/error-handling/'>error handling</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://kennyyu.me/blog/2014/03/19/c-error-handling/" data-via="" data-counturl="http://kennyyu.me/blog/2014/03/19/c-error-handling/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/11/18/bootcamps/" title="Previous Post: Learning Through Bootcamps">&laquo; Learning Through Bootcamps</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/03/19/c-error-handling/">C Error Handling</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/bootcamps/">Learning Through Bootcamps</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/20/omnibox-gdrive-search/">Omnibox GDrive Search</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/10/pipeline-for-improving-hand-tracking-accuracy/">Pipeline for Improving Hand Tracking Accuracy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/22/java-flag-command-line-library/">Java Flag Command Line Library</a>
      </li>
    
  </ul>
</section>




<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/binary-search' style='font-size: 120.0%'>binary search</a> <a href='/blog/categories/c' style='font-size: 120.0%'>c</a> <a href='/blog/categories/c-' style='font-size: 120.0%'>c++</a> <a href='/blog/categories/chrome-extension' style='font-size: 120.0%'>chrome extension</a> <a href='/blog/categories/compilers' style='font-size: 120.0%'>compilers</a> <a href='/blog/categories/computer-vision' style='font-size: 120.0%'>computer vision</a> <a href='/blog/categories/coupling' style='font-size: 120.0%'>coupling</a> <a href='/blog/categories/design' style='font-size: 120.0%'>design</a> <a href='/blog/categories/error-handling' style='font-size: 120.0%'>error handling</a> <a href='/blog/categories/flags' style='font-size: 120.0%'>flags</a> <a href='/blog/categories/git' style='font-size: 120.0%'>git</a> <a href='/blog/categories/java' style='font-size: 140.0%'>java</a> <a href='/blog/categories/javascript' style='font-size: 140.0%'>javascript</a> <a href='/blog/categories/knewton' style='font-size: 120.0%'>knewton</a> <a href='/blog/categories/layout' style='font-size: 120.0%'>layout</a> <a href='/blog/categories/markov-chains' style='font-size: 120.0%'>markov chains</a> <a href='/blog/categories/math' style='font-size: 160.0%'>math</a> <a href='/blog/categories/octopress' style='font-size: 140.0%'>octopress</a> <a href='/blog/categories/opencv' style='font-size: 120.0%'>opencv</a> <a href='/blog/categories/probability' style='font-size: 120.0%'>probability</a> <a href='/blog/categories/proofs' style='font-size: 120.0%'>proofs</a> <a href='/blog/categories/python' style='font-size: 140.0%'>python</a> <a href='/blog/categories/statistics' style='font-size: 120.0%'>statistics</a> <a href='/blog/categories/teaching' style='font-size: 120.0%'>teaching</a> <a href='/blog/categories/unix' style='font-size: 120.0%'>unix</a> </span>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kennyyu">@kennyyu</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kennyyu',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Kenny Yu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kennyyu';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kennyyu.me/blog/2014/03/19/c-error-handling/';
        var disqus_url = 'http://kennyyu.me/blog/2014/03/19/c-error-handling/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
